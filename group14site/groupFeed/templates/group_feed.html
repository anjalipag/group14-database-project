<!-- ChatGPT was used to style this page to make it look aesthetic -->

{% load static %}

<!-- Bootstrap 4.5.2 -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

<!-- Custom Styles -->
<link href="{% static 'css/base.css' %}" rel="stylesheet">

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100..900;1,100..900&family=Special+Gothic+Expanded+One&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarText">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item active">
        <a class="nav-link" href="/group/saved">My Groups</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/saved">Saved Recommendations</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/group/browse">Browse Groups</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/group/create">Create Group</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/">Logout</a>
      </li>
    </ul>
  </div>
</nav>

<!-- Main Content -->
<div class="container my-5">
  <div class="text-right mb-4">
    <button class="btn btn-success" data-toggle="modal" data-target="#recommendationModal">
      + Add Recommendation
    </button>
  </div>

  {% for category, posts in category_posts.items %}
    <div class="card mb-5 shadow-sm">
      <div class="card-header bg-dark text-white">
        <h2 class="mb-0">{{ category }}</h2>
      </div>
      <div class="card-body poppins-bold p-0">
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead class="thead-dark">
              <tr>
                <th scope="col">Title</th>
                <th scope="col">Description</th>
                <th scope="col">Rating</th>
                <th scope="col">Posted By</th>
                <th scope="col">Posted At</th>
                <th scope="col">View More</th>
              </tr>
            </thead>
            <tbody class="poppins-regular">
              {% for post in posts %}
                <tr>
                  <td><strong>{{ post.title }}</strong></td>
                  <td>{{ post.description }}</td>
                  <td>{{ post.overall_rating }}</td>
                  <td>{{ post.posted_by }}</td>
                  <td>{{ post.time_stamp }}</td>
                  <td>
                    <a href="{% url 'group_detail' post.post_id %}" class="btn btn-sm btn-outline-primary">Learn More</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<!-- Add Recommendation Modal -->
<div class="modal fade" id="recommendationModal" tabindex="-1" role="dialog" aria-labelledby="recommendationModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form method="post" action="{% url 'add_recommendation' group_id %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="recommendationModalLabel">Add a Recommendation</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label for="title">Title</label>
            <input type="text" class="form-control" id="title" name="title" required>
            <small id="spotifyHelp" class="form-text text-muted" style="display: none;">
              Start typing to search Spotify for music tracks
            </small>
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
          </div>

          <div class="form-group">
           <label for="category_name">Category Name</label>
            <select class="form-control" id="category_name" name="category_name" required>
              {% for category in category_names %}
                <option value="{{ category.0 }}">{{ category.0 }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="overall_rating">Rating (1â€“5)</label>
            <input type="number" min="1" max="5" class="form-control" id="overall_rating" name="overall_rating" required>
          </div>

          <div class="form-group">
            <label for="extra_info">External Link (optional)</label>
            <input type="url" class="form-control" id="extra_info" name="extra_info">
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Submit</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts for Bootstrap 4 -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<!-- Spotify Autocomplete Script -->
<hr>
<h3>Search Deezer for Songs</h3>
<input type="text" id="deezerQuery" placeholder="Type a song name..." />
<button onclick="searchDeezer()">Search</button>

<ul id="deezerResults"></ul>

<script>
function searchDeezer() {
    const query = document.getElementById('deezerQuery').value;

    fetch(`/group/feed/search/?query=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const results = document.getElementById('deezerResults');
            results.innerHTML = '';

            if (data.error) {
                results.innerHTML = `<li>Error: ${data.error}</li>`;
                return;
            }

            data.tracks.forEach(track => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <strong>${track.title}</strong> by ${track.artist}<br>
                    <a href="${track.deezer_url}" target="_blank">Listen on Deezer</a><br>
                    ${track.preview_url ? `<audio controls src="${track.preview_url}"></audio>` : '<em>No preview available</em>'}
                `;
                results.appendChild(li);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('deezerResults').innerHTML = '<li>Something went wrong!</li>';
        });
}
</script>
